<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Staging Template">
    <meta name="keywords" content="Staging, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>My Page</title>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbit&display=swap" rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
    <link rel="stylesheet" href="/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
<!-- Page Preloder -->
<div id="preloder">
    <div class="loader"></div>
</div>

<!-- Offcanvas Menu Begin -->
<div class="offcanvas-menu-overlay"></div>
<div class="offcanvas-menu-wrapper">
    <div class="offcanvas__logo">
        <a href="#" style="font-size: 40px; color: white">MyCloset</a>
    </div>
    <div id="mobile-menu-wrap"></div>
</div>
<!-- Offcanvas Menu End -->

<!-- Header Section Begin -->
<header class="header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-3">
                <div class="header__logo">
                    <a href="#" style="font-size: 40px; color: white">MyCloset</a>
                </div>
            </div>
            <div class="col-lg-6">
                <nav class="header__menu mobile-menu">
                    <ul>
                        <li class="active"><a id="goIndex" onclick="goToIndex()">Home</a></li>
                        <li><a id="goMyPage" onclick="goToMyPage()">MyPage</a></li>
                        <li><a id="goCloset" onclick="goToCloset()">Closet</a></li>
                        <li><a id="goChatbot" onclick="goToChatbot()">Chatbot</a></li>
                        <li><a id="goCommunity" onclick="goToCommunity()">Community</a></li>
                        <li><a id="goStyle" onclick="goToStyle()">Style</a></li>
                        <li><a id="goStyleDictionary" onclick="goToStyleDictionary()">Style Dictionary</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="canvas__open"><i class="fa fa-bars"></i></div>
    </div>
</header>
<!-- Header Section End -->

<!-- Contact Section Begin -->
<!-- DB 값 불러오는 영역 -->
<form id="f">
    <section class="contact spad" style="background-color: #5a6268; margin-bottom: -100px">
        <div class="container">
            <div class="card border-secondary mb-3" style="height: 650px">
                <div class="card-header">마이페이지</div>
                <div class="card-body">
                    <div>
                        <label for="nickName" class="form-label mt-4">nickname</label>
                        <div style="display: flex; justify-content: space-between">
                            <input type="text" class="form-control" name="nickName" id="nickName" placeholder="nickname"
                                   style="width: 75%">
                            <button id="checkNickName" class="btn btn-outline-dark" type="button" style="width: 20%">
                                확인
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="userId" class="form-label mt-4">ID</label>
                        <input type="text" class="form-control" name="userId" id="userId" aria-describedby="emailHelp"
                               placeholder="ID"
                               readonly>
                    </div>
                    <div>
                        <label for="email" class="form-label mt-4">email</label>
                        <div style="display: flex; justify-content: space-between">
                            <input type="text" class="form-control" id="email" name="email" placeholder="name"
                                   style="width: 75%">
                            <button id="checkEmail" class="btn btn-outline-dark" type="button" style="width: 20%">확인
                            </button>
                        </div>
                    </div>
                    <div style="float: right; width: 45%">
                        <label for="userId" class="form-label mt-4">gender</label>
                        <input type="text" class="form-control" id="gender" name="gender" aria-describedby="emailHelp"
                               placeholder="gender" readonly>
                    </div>
                    <div style="float: left; width: 45%">
                        <label for="userId" class="form-label mt-4">age</label>
                        <input type="text" class="form-control" id="age" name="age" aria-describedby="emailHelp"
                               placeholder="age">
                    </div>
                    <div style="clear: both"></div>
                    <hr>
                    <div class="card-body" style="float: left; width: 33%">
                        <button type="button" class="btn btn-danger" style="width: 100%" id="openModalBtn">탈퇴</button>
                    </div>
                    <div class="card-body" style="float: right; width: 33%">
                        <button id="btnUpdateUserInfo" type="button" class="btn btn-outline-dark" style="width: 100%">수정</button>
                    </div>
                    <div class="card-body" style="float: right; width: 33%">
                        <button onclick="history.back()" type="button" class="btn btn-outline-dark" style="width: 100%">취소
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</form>
<!-- 회원탈퇴 확인 모달창 -->
<div class="modal align-items-center" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">알림</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeModalBtn"
                        style="border: none; background-color: white">
                    <span aria-hidden="true">X</span>
                </button>
            </div>
            <div class="modal-body">
                <p>정말 탈퇴하시겠습니까?</p>
            </div>
            <div class="modal-footer">
                <button id="btnLeave" type="button" class="btn btn-danger">탈퇴</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
<!-- 모달창 끝 -->
<!-- Contact Section End -->

<!-- Footer Section Begin -->
<footer class="footer set-bg" data-setbg="/img/footer-bg.jpg">
    <div class="container">
        <div class="copyright" style="margin-top: -90px">
            <div class="row">
                <div class="col-lg-8 col-md-7">
                    <div class="copyright__text">
                        <p>Copyright ©
                            <script>
                                document.write(new Date().getFullYear());
                            </script>
                            All rights reserved | This template is made with <i class="fa fa-heart-o"
                                                                                aria-hidden="true"></i> by <a
                                    href="https://colorlib.com" target="_blank">Colorlib</a>
                        </p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-5">
                    <div class="copyright__widget">
                        <a href="#">Terms of use</a>
                        <a href="#">Privacy Policy</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- Footer Section End -->

<!-- Js Plugins -->
<script src="/js/jquery-3.6.0.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.slicknav.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/slick.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/common.js"></script>
<script src="/js/jquery.serializeObject.min.js"></script>
<script>
    // 모달 열기 버튼에 이벤트 핸들러 추가
    document.getElementById('openModalBtn').addEventListener('click', function () {
        $('#exampleModal').modal('show');
    });

    // X 버튼 클릭 시 모달 닫기
    document.getElementById('closeModalBtn').addEventListener('click', function () {
        $('#exampleModal').modal('hide');
    });

    // 취소 버튼 클릭 시 모달 닫기
    document.querySelector('#exampleModal .btn-secondary').addEventListener('click', function () {
        $('#exampleModal').modal('hide');
    });

    // 숫자만 가능
    function onlyNumber(value) {
        return /^[0-9]{1,2}$/.test(value);
    }


    let olderEmail = "";
    let olderNickName = "";

    // HTML 로딩이 완료되고, 실행
    $(document).ready(function () {

        let f = document.getElementById("f");
        f.addEventListener('submit', ev => {
            console.log(ev);
            ev.stopPropagation();
            ev.preventDefault();
        })

        let emailResult = 0;
        let nickNameResult = 0;

        console.log(loginUserId);

        // 회원정보 가져오기
        userInfo();

        // 탈퇴하기
        $("#btnLeave").on("click", function () {
            $.ajax({
                url: "http://" + apiServer + "/user/v1/deleteUserInfo",
                type: "post",
                dataType: "JSON",
                xhrFields: {
                    withCredentials: true
                }
            }).then(function (json) {
                if (json.data.result === 1) {
                    alert(json.data.msg);
                    location.href = "/index.html"
                } else {
                    alert(json.data.msg);
                    f.name.focus();
                }
            })
        })

        // 회원정보 수정
        $("#btnUpdateUserInfo").on("click", function () {

            if (f.nickName.value === "") {
                alert("닉네임을 입력하세요.");
                f.nickName.focus();
                return;
            }
            if (f.email.value === "") {
                alert("이메일을 입력하세요.");
                f.email.focus();
                return;
            }
            if (f.age.value === "") {
                alert("나이를 입력하세요.");
                f.age.focus();
                return;
            }
            if (onlyNumber(f.age.value) === false) {
                alert("숫자만 입력 가능합니다.")
                return;
            }
            if (emailResult === 0) {
                alert("Email 중복확인을 하시길 바랍니다.")
                return;
            }
            if (nickNameResult === 0) {
                alert("닉네임 중복확인을 하시길 바랍니다.")
                return;
            }

            if (emailResult === 1 && nickNameResult === 1) {
                $.ajax({
                    url: "http://" + apiServer + "/user/v1/updateUserInfo",
                    type: "post",
                    dataType: "JSON",
                    xhrFields: {
                        withCredentials: true
                    },
                    data: $("#f").serializeObject()
                }).then(
                    function (json) {
                        if (json.data.result === 1) {
                            alert(json.data.msg);
                            console.log("이거실행")
                            location.href = "/user/myPage.html"
                        } else {
                            alert(json.data.msg);
                            console.log("이거실행")
                            $("#name").focus();
                        }
                    }
                )
            } else {
                alert("회원정보 수정에 실패하였습니다. 다시 시도하시길 바랍니다.");
                return;
            }
        })

        $("#checkEmail").on("click", function () {

                let emailFormat = /^[A-Za-z0-9_\.\-]+@[A-Za-z0-9\-]+\.[A-Za-z0-9\-]+/;

                console.log(olderEmail);

                if (f.email.value === "") {
                    alert("이메일을 입력하세요.");
                    f.email.focus();
                    return;
                }

                if (!emailFormat.test(f.email.value)) {
                    alert("올바른 이메일 형식으로 입력하세요.");
                    f.email.focus();
                    return;
                }

                if (!(f.email.value === olderEmail)) {
                    $.ajax({
                        url: "http://" + apiServer + "/security/v1/checkEmail",
                        type: "post",
                        dataType: "JSON",
                        xhrFields: {
                            withCredentials: true
                        },
                        data: {email: f.email.value}
                    }).then(
                        function (json) {
                            if (json.data.result == 1) {
                                alert(json.data.msg);
                                emailResult = 1;
                                console.log(emailResult);
                                $("#userId").focus();
                            } else {
                                alert(json.data.msg);
                                console.log(emailResult);
                                $("#email").focus();
                            }
                        }
                    )
                } else {
                    alert("동일한 이메일을 사용합니다.")
                    emailResult = 1;
                    console.log(f.email.value)
                }
            }
        )

        $("#checkNickName").on("click", function () {

            console.log(olderNickName);

            if (f.nickName.value === "") {
                alert("닉네임을 입력하세요.");
                f.nickName.focus();
                return;
            }

            if (!(f.nickName.value === olderNickName)) {
                $.ajax({
                    url: "http://" + apiServer + "/security/v1/checkNickName",
                    type: "post",
                    dataType: "JSON",
                    xhrFields: {
                        withCredentials: true
                    },
                    data: {nickName: f.nickName.value}
                }).then(
                    function (json) {
                        if (json.data.result == 1) {
                            alert(json.data.msg);
                            nickNameResult = 1;
                            console.log(nickNameResult);
                            $("#email").focus();
                        } else {
                            alert(json.data.msg);
                            console.log(nickNameResult);
                            $("#nickname").focus();
                        }
                    }
                )
            } else {
                alert("동일한 닉네임을 사용합니다.");
                nickNameResult =1;
                console.log(f.nickName.value);
            }
        })

    })

    // 회원정보 불러오기 함수
    function userInfo() {
        // 컨트롤러에 요청하기
        $.ajax({
            url: "http://" + apiServer + "/user/v1/userInfo",
            type: "post",
            dataType: "JSON",
            xhrFields: {
                withCredentials: true
            }
        }).then(
            function (json) {
                const userInfo = json.data;

                $("#userId").val(userInfo.userId);
                $("#nickName").val(userInfo.nickName);
                $("#name").val(userInfo.name);
                $("#email").val(userInfo.email);
                $("#gender").val(userInfo.gender);
                $("#age").val(userInfo.age);

                console.log(userInfo.userId);
                console.log(userInfo.nickName);
                console.log(userInfo.name);
                console.log(userInfo.email);
                console.log(userInfo.gender);
                console.log(userInfo.age);

                olderEmail = userInfo.email;
                olderNickName = userInfo.nickName;
            },
            function () {
                alert("로그인 해주시길 바랍니다.");

            }
        );
    }

</script>

</body>

</html>